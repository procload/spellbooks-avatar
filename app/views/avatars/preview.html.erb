<%= turbo_frame_tag "avatar_preview" do %>
  <div class="avatar-preview">
    <% if @avatar.nil? %>
      <%= image_tag "avatar-placeholder.svg", alt: "Avatar preview", width: 256, height: 256, class: "avatar-preview__placeholder" %>
    <% elsif @avatar.image_present? %>
      <%= image_tag @avatar.data_url, alt: "Generated Avatar", width: 256, height: 256, class: "avatar-preview__image" %>
    <% elsif @avatar.failed? %>
      <div class="avatar-preview__error">
        <%= image_tag "avatar-placeholder.svg", alt: "Avatar preview", width: 256, height: 256, class: "avatar-preview__placeholder" %>
        <p><strong>Generation failed:</strong> <%= @avatar.error_message %></p>
      </div>
    <% else %>
      <div class="avatar-preview__loading">
        <%= image_tag "avatar-placeholder.svg", alt: "Avatar preview", width: 256, height: 256, class: "avatar-preview__placeholder" %>
        <p>Generating your avatar... <span class="loading-spinner">‚è≥</span></p>
      </div>
      <% # Auto-refresh while processing %>
      <turbo-stream action="refresh" target="avatar_preview">
        <template>
          <meta name="turbo-refresh-method" content="morph" />
          <meta name="turbo-refresh-scroll" content="preserve" />
        </template>
      </turbo-stream>
    <% end %>
  </div>
<% end %>

<% if @avatar&.processing? %>
  <script>
    setTimeout(() => {
      const frame = document.getElementById('avatar_preview');
      if (frame) frame.reload();
    }, 2000);
  </script>
<% end %>
